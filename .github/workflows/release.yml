name: Release

on:
  # You can manually run this workflow.
  workflow_dispatch:
  # This workflow runs on pushing a semantic versionized tag (e.g. v1.0.0).
  push:
    #branches:
    #  - main
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:

# ---------------------------------------------------------------------------------------

  release:

# ---------------------------------------------------------------------------------------

    name: "Publish Container on GHCR"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Versionize
        run: |
          TIMESTAMP=$(TZ=UTC date +%Y%m%d)
          SHORT_HASH=$(echo ${{ github.sha }} | head -c7)
          if [[ "$GITHUB_REF" =~ ^refs/tags/v* ]]; then
            echo "Releasing from tag: $GITHUB_REF_NAME"
            echo "TAG=$GITHUB_REF_NAME"
          else
            echo "Releasing from branch: $GITHUB_REF_NAME"
            echo "TAG=$TIMESTAMP-$SHORT_HASH" >> $GITHUB_ENV
          fi
          echo "Container Version:" $TAG

      - name: Build Image
        run: |
          docker build --no-cache --progress=plain -t ghcr.io/${{ github.repository }}:$TAG .devcontainer/

      - name: Push Image to registry
        run: |
          docker push  ghcr.io/${{ github.repository }}:$TAG
          docker tag   ghcr.io/${{ github.repository }}:$TAG ghcr.io/${{ github.repository }}:latest
          docker push  ghcr.io/${{ github.repository }}:latest
